<?php
// 1. Xətaları gizlət (İstifadəçi görməsin, amma loga yazılsın)
ini_set('display_errors', 0); 
error_reporting(E_ALL);
session_start();

// 2. Xəta log funksiyası (Orijinal kodun saxlanıldı)
function logError($error, $function = '', $line = '', $chatId = '') {
    $logData = [
        'timestamp' => date('Y-m-d H:i:s'),
        'error' => $error,
        'function' => $function,
        'line' => $line,
        'chat_id' => $chatId
    ];
    $logFile = 'error_logs.json';
    $logs = file_exists($logFile) ? json_decode(file_get_contents($logFile), true) ?? [] : [];
    $logs[] = $logData;
    $logs = array_slice($logs, -1000);
    file_put_contents($logFile, json_encode($logs, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    return $logData;
}

// 3. Database bağlantısı
$servername = "localhost";
$username = "pantamue_users";
$password = "BTD2HS39ycgjwb.";
$dbname = "pantamue_date";

try {
    $conn = new mysqli($servername, $username, $password, $dbname);
    if ($conn->connect_error) {
        throw new Exception("Database error");
    }
    $conn->set_charset("utf8mb4");
} catch (Exception $e) {
    // Xətanı istifadəçiyə göstərmə, loga yaz
    logError($e->getMessage(), 'DB Connection', __LINE__);
    die("Sistem müvəqqəti olaraq əlçatmazdır."); 
}

// 4. Cədvəl yoxlanışı (Hər dəfə işləməməsi üçün optimize edildi)
$createTableSQL = "CREATE TABLE IF NOT EXISTS lunex_bot (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    tg_id VARCHAR(50) UNIQUE NOT NULL,
    full_name VARCHAR(255) DEFAULT 'İstifadəçi',
    invited_by VARCHAR(50) DEFAULT NULL,
    wallet_balance DECIMAL(10,4) DEFAULT 0.0000,
    referral_total INT DEFAULT 0,
    ads_watched_today INT DEFAULT 0,
    bonus_ads_watched INT DEFAULT 0,
    membership_tier INT DEFAULT 1,
    energy_points INT DEFAULT 100,
    referral_code VARCHAR(50) UNIQUE,
    registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;";
$conn->query($createTableSQL);

// 5. Parametrlər
$adRewardAZN = 0.001;
$maxDailyAds = 150;

function formatBalance($amount) {
    return number_format((float)$amount, 4, '.', '') . ' ₼';
}

function generateReferralCode($tgId) {
    return 'ref_' . $tgId;
}

// 6. İstifadəçi təyini
$tgId = $_GET['chatId'] ?? $_GET['userId'] ?? $_GET['tg_id'] ?? 'GUEST';

if ($tgId !== 'GUEST') {
    $stmt = $conn->prepare("SELECT * FROM lunex_bot WHERE tg_id = ?");
    $stmt->bind_param('s', $tgId);
    $stmt->execute();
    $result = $stmt->get_result();
    
    if ($result->num_rows > 0) {
        $userData = $result->fetch_assoc();
    } else {
        // Yeni istifadəçi yarat
        $refCode = generateReferralCode($tgId);
        $ins = $conn->prepare("INSERT INTO lunex_bot (tg_id, referral_code) VALUES (?, ?)");
        $ins->bind_param('ss', $tgId, $refCode);
        $ins->execute();
        $userData = [
            'tg_id' => $tgId,
            'wallet_balance' => 0,
            'ads_watched_today' => 0,
            'referral_code' => $refCode
        ];
    }
    $stmt->close();
} else {
    $userData = ['tg_id' => 'GUEST', 'wallet_balance' => 0, 'ads_watched_today' => 0];
}

// 7. AJAX Reklam İzləmə (POST sorğusu gəldikdə)
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['watch_ad'])) {
    header('Content-Type: application/json');
    if ($tgId === 'GUEST') {
        echo json_encode(['success' => false, 'message' => 'Qonaq istifadəçi qazana bilməz']);
        exit;
    }

    $conn->begin_transaction();
    $stmt = $conn->prepare("SELECT wallet_balance, ads_watched_today FROM lunex_bot WHERE tg_id = ? FOR UPDATE");
    $stmt->bind_param('s', $tgId);
    $stmt->execute();
    $u = $stmt->get_result()->fetch_assoc();

    if ($u['ads_watched_today'] < $maxDailyAds) {
        $newBal = $u['wallet_balance'] + $adRewardAZN;
        $newCount = $u['ads_watched_today'] + 1;
        
        $upd = $conn->prepare("UPDATE lunex_bot SET wallet_balance = ?, ads_watched_today = ? WHERE tg_id = ?");
        $upd->bind_param('dis', $newBal, $newCount, $tgId);
        $upd->execute();
        $conn->commit();
        
        echo json_encode([
            'success' => true, 
            'balance' => number_format($newBal, 4, '.', ''),
            'count' => $newCount,
            'message' => 'Mükafat balansınıza əlavə edildi!'
        ]);
    } else {
        echo json_encode(['success' => false, 'message' => 'Günlük limit dolub!']);
    }
    exit;
}
?>
<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lunex Bot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS Orijinal saxlanıldı, Mini App üçün optimize edildi */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; }
        body { font-family: sans-serif; background: #1a1a1a; color: white; overflow: hidden; }
        .top-bar { padding: 15px; background: rgba(0,0,0,0.8); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .balance-amount { font-size: 20px; font-weight: bold; color: #00ff00; }
        .main-content { padding: 20px; text-align: center; height: 80vh; display: flex; flex-direction: column; justify-content: center; }
        .ad-card { background: #2d2d2d; padding: 30px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .watch-ad-btn { background: #fff; color: #000; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; font-size: 18px; cursor: pointer; width: 100%; margin-top: 20px; }
        .watch-ad-btn:disabled { background: #555; }
        .progress-bar { height: 10px; background: #444; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: #00ff00; transition: 0.3s; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; display: flex; background: #000; padding: 15px; border-top: 1px solid #333; }
        .nav-item { flex: 1; text-align: center; color: #888; font-size: 12px; }
        .nav-item.active { color: #fff; }
        .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; padding: 10px 20px; border-radius: 10px; display: none; z-index: 10000; }
    </style>
</head>
<body>

<div class="notification" id="notif"></div>

<div class="top-bar">
    <div><b>LUNEX</b></div>
    <div class="balance-section">
        <div id="topBalance" class="balance-amount"><?php echo formatBalance($userData['wallet_balance']); ?></div>
    </div>
</div>

<div class="main-content">
    <div class="ad-card">
        <h2 id="adsWatched"><?php echo $userData['ads_watched_today']; ?> / <?php echo $maxDailyAds; ?></h2>
        <p>Günlük Reklam Limiti</p>
        
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: <?php echo ($userData['ads_watched_today']/$maxDailyAds)*100; ?>%"></div>
        </div>

        <button class="watch-ad-btn" id="adBtn" onclick="handleWatchAd()" <?php echo ($userData['ads_watched_today'] >= $maxDailyAds) ? 'disabled' : ''; ?>>
            <i class="fas fa-play"></i> Reklam İzlə
        </button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active"><i class="fas fa-home"></i><br>Ana Səhifə</div>
    <div class="nav-item"><i class="fas fa-wallet"></i><br>Çıxarış</div>
    <div class="nav-item"><i class="fas fa-users"></i><br>Referal</div>
</div>

<script src='//libtl.com/sdk.js' data-zone='10290280' data-sdk='show_10290280'></script>
<script>
function showMsg(m) {
    const el = document.getElementById('notif');
    el.textContent = m;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 3000);
}

function handleWatchAd() {
    const btn = document.getElementById('adBtn');
    btn.disabled = true;
    btn.textContent = "Yüklənir...";

    // 1. Reklamı göstər
    if (typeof show_10290280 === 'function') {
        show_10290280();
    }

    // 2. 10 saniyə gözlə (Server məntiqinə uyğun)
    setTimeout(() => {
        fetch('', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'watch_ad=1'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('topBalance').textContent = data.balance + ' ₼';
                document.getElementById('adsWatched').textContent = data.count + ' / <?php echo $maxDailyAds; ?>';
                document.getElementById('progressFill').style.width = (data.count / <?php echo $maxDailyAds; ?> * 100) + '%';
                showMsg(data.message);
            } else {
                showMsg(data.message);
            }
            if (data.count < <?php echo $maxDailyAds; ?>) {
                btn.disabled = false;
                btn.textContent = "Reklam İzlə";
            } else {
                btn.textContent = "Limit Doldu";
            }
        });
    }, 10000);
}
</script>
</body>
</html>
